
name: Auto_PR_for_manifests_branches

on:
  push:
    branches:
      - 'nbo-manifests/**'

permissions:
  contents: write
  pull-requests: write
  checks: read
  statuses: read

jobs:
  auto-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Create/Reuse PR → Approve → Wait → Merge
        uses: actions/github-script@v7
        with:
          script: |
            const base = "master";
            const { owner, repo } = context.repo;
            const head = context.ref.replace("refs/heads/", "");

            if (head === base) {
              core.info("No PR needed for base branch.");
              return;
            }

            // --- 1. Create or reuse PR ---
            let pr;
            try {
              const created = await github.rest.pulls.create({
                owner, repo, base, head,
                title: `Auto PR: ${head} → ${base}`
              });
              pr = created.data;
              core.info(`Created PR #${pr.number}`);
            } catch (e) {
              if (e.status === 422) {
                const { data: prs } = await github.rest.pulls.list({
                  owner, repo, state: "open", base,
                  head: `${owner}:${head}`
                });
                if (!prs.length) throw e;
                pr = prs[0];
                core.info(`Reusing PR #${pr.number}`);
              } else {
                throw e;
              }
            }

            // --- 2. Approve PR (may not count if human/CO required) ---
            try {
              await github.rest.pulls.createReview({
                owner, repo, pull_number: pr.number,
                event: "APPROVE"
              });
              core.info("Approved PR.");
            } catch (e) {
              core.info("Bot approval not allowed or not needed.");
            }

            // --- 3. Wait until PR is mergeable_state = 'clean' ---
            const maxWait = 20 * 60 * 1000; // 20 minutes
            const interval = 10 * 1000;     // 10 sec
            const endTime = Date.now() + maxWait;

            core.info("Waiting for all required checks to pass...");

            while (Date.now() < endTime) {
              const prStatus = (await github.rest.pulls.get({
                owner, repo, pull_number: pr.number
              })).data;

              core.info(`mergeable_state = ${prStatus.mergeable_state}`);

              if (prStatus.mergeable_state === "clean") {
                core.info("PR is ready to merge.");
                break;
              }

              if (["dirty", "blocked"].includes(prStatus.mergeable_state)) {
                core.info("PR is blocked by checks                core.info("PR is blocked by checks/reviews. Continuing to wait...");
              }

              await new Promise(r => setTimeout(r, interval));
            }

            // Re-check
            const finalPR = (await github.rest.pulls.get({
              owner, repo, pull_number: pr.number
            })).data;

            if (finalPR.mergeable_state !== "clean") {
              throw new Error(`Checks didn't pass in time. mergeable_state=${finalPR.mergeable_state}`);
            }

            // --- 4. Merge ---
            await github.rest.pulls.merge({
              owner, repo, pull_number: pr.number,
              merge_method: "merge"
            });

