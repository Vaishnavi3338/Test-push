
name: Auto_PR_for_manifests_branches

on:
  push:
    branches:
      - "nbo-manifests/**"

permissions:
  contents: write
  pull-requests: write
  checks: read
  statuses: read

jobs:
  auto-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Create/Reuse PR → Approve → Wait → Merge
        uses: actions/github-script@v7
        with:
          script: |
            const base = "main";
            const { owner, repo } = context.repo;
            const head = context.ref.replace("refs/heads/", "");

            if (head === base) {
              core.info("Head equals base; skipping.");
              return;
            }

            let pr;
            try {
              const created = await github.rest.pulls.create({
                owner: owner,
                repo: repo,
                base: base,
                head: head,
                title: `Auto PR: ${head} → ${base}`
              });
              pr = created.data;
              core.info(`Created PR #${pr.number}`);
            } catch (e) {
              if (e.status === 422) {
                const prsList = await github.rest.pulls.list({
                  owner: owner,
                  repo: repo,
                  state: "open",
                  base: base,
                  head: `${owner}:${head}`
                });
                const prs = prsList.data;
                if (prs.length === 0) {
                  throw e;
                }
                pr = prs[0];
                core.info(`Reusing PR #${pr.number}`);
              } else {
                throw e;
              }
            }

            try {
              await github.rest.pulls.createReview({
                owner: owner,
                repo: repo,
                pull_number: pr.number,
                event: "APPROVE"
              });
              core.info("Approved PR (bot).");
            } catch (e) {
              core.info(`Bot approval skipped: ${e.message}`);
            }

            const maxWaitMs = 20 * 60 * 1000;
            const intervalMs = 10 * 1000;
            const deadline = Date.now() + maxWaitMs;

            while (Date.now() < deadline) {
              const prStatusResp = await github.rest.pulls.get({
                owner: owner,
                repo: repo,
                pull_number: pr.number
              });
              const prStatus = prStatusResp.data;

              core.info(`mergeable_state=${prStatus.mergeable_state}`);

              if (prStatus.mergeable_state === "clean") {
                break;
              }

              await new Promise(resolve => setTimeout(resolve, intervalMs));
            }

            const finalPRResp = await github.rest.pulls.get({
              owner: owner,
              repo: repo,
              pull_number: pr.number
            });
            const finalPR = finalPRResp.data;

            if (finalPR.mergeable_state !== "clean") {
              throw new Error(`Timeout: protections not satisfied. mergeable_state=${finalPR.mergeable_state}`);
            }

            await github.rest.pulls.merge({
              owner: owner,
              repo: repo,
              pull_number: pr.number,
              merge_method: "merge"
            });

           
